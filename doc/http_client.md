# http client 设计
最早想使用 http client 功能的时候，作者想的 是引入一个第三方开源的异步 http 客户端，
但是经过调研下来，还是决定自己实现一个 http client.
有以下原因： 
1. 异步模型不兼容，大部分的 http 依赖于 netty-reactor. 而本项目是基于 子定义的 Observable 模型，引入第三方依赖会增加包体积
2. 作为网关 使用场景，希望可以优先在当前线程处理 upstream 的连接，而不是每次都把请求提交给别的线程发送，这样会损失性能。
3. 将来可以方便的扩展其它协议（websocket，隧道协议等）
http client 支持两个核心功能，DNS 解析 和 连接池
### DNS
DNS 解析 使用了 netty 的 异步 DNS 解析功能。可以实现 异步的 http 解析，而不是调用操作系统的 DNS 能力。

### 连接池
在设计 连接池的时候，作者参考了 大量 的 http 连接池设计，其中包括 nginx、java_apache_httpclient，OK_http 等
本项目设计的连接池有一些独特的优势。
1. 连接池所使用的 线程 和 http server 是同组线程，每个线程组成一个环形队列，获取连接时，首先查看当前线程 有没有空闲连接，如果当前线程有空闲连接
则使用当前线程的连接，如果当前线程没有连接，则逐个检查其它线程的连接并使用（可以关闭），如果都没有，则在当前线程发起连接。这对于性能的提升非常有作用，
使用当前线程的连接确保 在网关处理请求的过程中没有上下文切换的开销，在并发量大的情况下，当前线程的连接命中率可以接近 100%，没有线程上下文切换开销。
而在小并发状态下，会有一定概率使用其它线程的连接，这样会有一定线程上下文切换的开销， 但是小并发状态下，机器的性能本来就很闲置，这种方式可以降低到和后端服务的tcp连接数。
区别于 nginx 多进程模型，每个进程都有一个连接池，都会建立连接到后端，连接利用率显著提高，而在大并发下，又有 nginx 但一线程独占连接池的性能优势
2. 获取连接采用的是后进先出（LIFO）的策略，而不是像 apache httpclient 一样使用先进先出的策略（FIFO）。设想一个场景，如果来了一部分瞬时流量，
创建了大量的连接，使用完成之后放回连接池，后续流量变成 一秒一次，采用 LIFO 策略可以不断的使用队列尾部的连接，而队列头部的连接会因为 空闲超时被关闭，
这样可以减少 对后端连接的数量，让单个连接保持频繁使用的状态。如果 采用 FIFO 策略，则每一个连接都会被均匀的使用到，导致对于单机维持大量的连接，
每个连接发送请求的频率不高，造成资源的浪费。

基于以上两点，即使使用java开发，使得该 http client 的性能非常接近于 nginx，远远高于其它 java 实现的同步、异步httpclient。